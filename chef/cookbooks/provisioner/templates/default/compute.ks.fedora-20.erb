# Kickstart file automatically generated by anaconda.

install
url --url <%= @os_install_site %>
<% if @online -%>
# Add support for our local proxy.
repo --name="Crowbar Local"  --baseurl=<%=@os_install_site %> --proxy="<%=@proxy%>" --cost=100
<% end %>
# key --skip
# Disable geolocation for language and timezone
# Currently broken by https://bugzilla.redhat.com/show_bug.cgi?id=1111717
# geoloc 0
timezone --utc UTC
lang en_US.UTF-8
keyboard us
# crowbar
rootpw --iscrypted <%= node[:crowbar][:provisioner][:server][:default_password_hash] %>
firewall --disabled
authconfig --enableshadow --enablemd5
selinux --disabled
bootloader --location=mbr --driveorder=sda --append="rhgb quiet"
zerombr
ignoredisk --only-use=sda
clearpart --all --drives=sda
part /boot --fstype ext4 --size=512 --ondisk=sda
part /boot/efi --fstype vfat --size=512 --ondisk=sda
part swap --recommended
part pv.6 --size=1 --grow --ondisk=sda
volgroup <%=@name.split('.')[0]%> --pesize=32768 pv.6
logvol / --fstype ext4 --name=lv_root --vgname=<%=@name.split('.')[0]%> --size=1 --grow
text
reboot

%packages
@core
trousers
fipscheck
device-mapper-multipath
openssh
curl.x86_64
efibootmgr
tar
%end

%post

exec > /root/post-install.log 2>&1
set -x
export PS4='${BASH_SOURCE}@${LINENO}(${FUNCNAME[0]}): '
<% unless @online -%>
(cd /etc/yum.repos.d && rm *)
<% end -%>

key_re='crowbar\.install\.key=([^ ]+)'
if [[ $(cat /proc/cmdline) =~ $key_re ]]; then
    export CROWBAR_KEY="${BASH_REMATCH[1]}"
    echo "$CROWBAR_KEY" >/etc/crowbar.install.key
elif [[ -f /etc/crowbar.install.key ]]; then
    export CROWBAR_KEY="$(cat /etc/crowbar.install.key)"
fi

hostname_re='crowbar\.fqdn=([^ ]+)'
if [[ $(cat /proc/cmdline) =~ $hostname_re ]]; then
   HOSTNAME=${BASH_REMATCH[1]}
   if [ -f /etc/sysconfig/network ] ; then
      sed -i -e "s/HOSTNAME=.*/HOSTNAME=${HOSTNAME}/" /etc/sysconfig/network
    fi
    echo "${HOSTNAME#*.}" >/etc/domainname
else
    echo "Cannot set hostname, we fail."
    sleep 999
    reboot -f
fi
echo "$HOSTNAME" > /etc/hostname
hostname "$HOSTNAME"

echo "proxy=<%=@proxy%>" >> /etc/yum.conf
sed -i '/^enabled/ s/1/0/' /etc/yum/pluginconf.d/fastestmirror.conf
echo "Setting up repositories"
<% @repos.keys.sort.each do |repo| -%>
  <% if repo == "online"
       rpm_sources, bare_sources = @repos[repo].keys.sort.partition{|r|r =~ /^rpm /} -%>
    <% bare_sources.each do |source|
         _, name, _, url = source.split -%>
cat >/etc/yum.repos.d/crowbar-<%=name%>.repo <<EOF
[crowbar-<%=name%>]
name=Crowbar <%=name%> Repo
baseurl=<%= url %>
gpgcheck=0
EOF
    <% end -%>
    <% rpm_sources.each do |repo|
         url = repo.split(' ',2)[1]
         file = url.split('/').last
         file = file << ".rpm" unless file =~ /\.rpm$/ -%>
(
export http_proxy=<%=@proxy%>
curl -o '/var/cache/<%=file%>' -L '<%=url%>'
rpm -Uvh '/var/cache/<%=file%>'
)
    <% end -%>
  <% else
    url = @repos[repo].keys.first -%>
cat >/etc/yum.repos.d/crowbar-<%=repo%>.repo <<EOF
[crowbar-<%=repo%>]
name=Crowbar <%=repo%> Repo
<%= url %>
gpgcheck=0
EOF
  <% end -%>
<% end -%>

# Install ntpdate
yum -y install ntpdate

# Make sure we can install gems
cat >/etc/gemrc <<EOF
:sources:
<% if @online -%>
- http://rubygems.org/
<% end -%>
- <%=@provisioner_web%>/gemsite/
gem: --no-ri --no-rdoc --bindir /usr/local/bin --http-proxy <%=@proxy%>
EOF

cp /etc/gemrc /root/.gemrc

rsyslog_dir="/etc/rsyslog.d"
mkdir -p "$rsyslog_dir"
echo '$IncludeConfig /etc/rsyslog.d/*.conf' >>/etc/rsyslog.conf
if [ ! -f "$rsyslog_dir/10-crowbar-client.conf" ]; then
    echo "*.* @@$<%= @logging_server %>" > "$rsyslog_dir/10-crowbar-client.conf"
    if ! curl -f -s -o "$rsyslog_dir/00-crowbar-debug.conf" \
        <%= @provisioner_web %>/rsyslog.d/00-crowbar-debug.conf
    then
        rm -f "$rsyslog_dir/00-crowbar-debug.conf"
    fi
fi

mkdir -p /root/.ssh
cat >/root/.ssh/authorized_keys <<EOF
<%= @keys %>
EOF

echo "PermitRootLogin without-password" >> /etc/ssh/sshd_config

# Allow client to pass http proxy environment variables
echo "AcceptEnv http_proxy https_proxy no_proxy" >> /etc/ssh/sshd_config

# Set up the default crowbar service.
curl -s -o /usr/sbin/crowbar "<%=@web_path%>/crowbar_join.sh"
chmod +x /usr/sbin/crowbar

cat >/etc/systemd/system/crowbar.service <<EOF
[Unit]
Description=Crowbar Node Checkin
Documentation=http://github.com/opencrowbar
After=sshd.service

[Service]
Type=oneshot
ExecStart=/usr/sbin/crowbar start

[Install]
WantedBy=multi-user.target
EOF

systemctl enable crowbar

# The network barclamp is in charge of doing horrible things
# to the network, not NetworkManager
chkconfig NetworkManager off || :

curl -u "$CROWBAR_KEY" --digest -L -X PUT -d "bootenv=local" \
    "<%=@api_server%>/api/v2/nodes/$HOSTNAME"

# Wait for the provisioner to change the bootenv
while true; do
      curl -s -f -L -o /tmp/bootstate "<%=@provisioner_web%>/nodes/$HOSTNAME/bootstate" && \
        [[ -f /tmp/bootstate && $(cat /tmp/bootstate) = local ]] && break
    sleep 1
done

sync
%end
